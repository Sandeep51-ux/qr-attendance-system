<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard - QR Attendance</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-success">
        <div class="container">
            <a class="navbar-brand" href="#">ðŸŽ¯ QR Attend - Student</a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text me-3">Welcome, {{ session.name }}</span>
                <a class="btn btn-outline-light btn-sm" href="{{ url_for('logout') }}">Logout</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Mark Attendance</h5>
                    </div>
                    <div class="card-body">
                        <p>To mark attendance:</p>
                        <ol>
                            <li>Click the "Scan QR Code" button below</li>
                            <li>Allow camera access when prompted</li>
                            <li>Point your camera at the teacher's QR code</li>
                            <li>Attendance will be marked automatically with location verification</li>
                        </ol>
                        <div class="text-center">
                            <a href="{{ url_for('scan_qr_page') }}" class="btn btn-success btn-lg">
                                ðŸ“± Scan QR Code
                            </a>
                        </div>
                        
                        <!-- Alternative manual method -->
                        <div class="mt-4">
                            <h6>Alternative Method:</h6>
                            <p class="small text-muted">If you have the QR code data from another scanner, you can use the manual entry option on the scan page.</p>
                        </div>
                        
                        <div id="attendanceResult" class="mt-3"></div>
                    </div>
                </div>
                
                <!-- Quick Stats Card -->
                <div class="card mt-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">My Attendance Summary</h5>
                    </div>
                    <div class="card-body">
                        {% if attendance %}
                            {% set total_classes = attendance|length %}
                            {% set verified_count = attendance|selectattr('location_verified')|list|length %}
                            <div class="row text-center">
                                <div class="col-6">
                                    <h4>{{ total_classes }}</h4>
                                    <p class="small">Total Classes</p>
                                </div>
                                <div class="col-6">
                                    <h4>{{ verified_count }}</h4>
                                    <p class="small">Verified âœ…</p>
                                </div>
                            </div>
                        {% else %}
                            <p class="text-muted text-center">No attendance records yet.</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">My Attendance History</h5>
                    </div>
                    <div class="card-body">
                        {% if attendance %}
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Subject</th>
                                            <th>Date</th>
                                            <th>Time</th>
                                            <th>Teacher</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for record in attendance %}
                                        <tr>
                                            <td>{{ record.subject }}</td>
                                            <td>{{ record.date }}</td>
                                            <td>{{ record.timestamp[11:16] if record.timestamp else 'N/A' }}</td>
                                            <td>{{ record.teacher_name }}</td>
                                            <td>
                                                <span class="badge bg-{{ 'success' if record.location_verified else 'warning' }}">
                                                    {{ 'Verified' if record.location_verified else 'Not Verified' }}
                                                </span>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <div class="text-center py-4">
                                <h5 class="text-muted">No attendance records yet.</h5>
                                <p class="text-muted">Scan a QR code from your teacher to mark attendance.</p>
                                <a href="{{ url_for('scan_qr_page') }}" class="btn btn-primary">Scan Your First QR Code</a>
                            </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Instructions Card -->
                <div class="card mt-4">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">ðŸ“‹ How to Use</h5>
                    </div>
                    <div class="card-body">
                        <div class="accordion" id="instructionsAccordion">
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingOne">
                                    <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne">
                                        Step 1: Access QR Scanner
                                    </button>
                                </h2>
                                <div id="collapseOne" class="accordion-collapse collapse show" data-bs-parent="#instructionsAccordion">
                                    <div class="accordion-body">
                                        Click the "Scan QR Code" button to open the scanner page.
                                    </div>
                                </div>
                            </div>
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingTwo">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo">
                                        Step 2: Allow Camera Access
                                    </button>
                                </h2>
                                <div id="collapseTwo" class="accordion-collapse collapse" data-bs-parent="#instructionsAccordion">
                                    <div class="accordion-body">
                                        When prompted, allow the browser to access your camera for scanning.
                                    </div>
                                </div>
                            </div>
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingThree">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree">
                                        Step 3: Scan QR Code
                                    </button>
                                </h2>
                                <div id="collapseThree" class="accordion-collapse collapse" data-bs-parent="#instructionsAccordion">
                                    <div class="accordion-body">
                                        Point your camera at the QR code displayed by your teacher. The scanner will automatically detect it.
                                    </div>
                                </div>
                            </div>
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingFour">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFour">
                                        Step 4: Location Verification
                                    </button>
                                </h2>
                                <div id="collapseFour" class="accordion-collapse collapse" data-bs-parent="#instructionsAccordion">
                                    <div class="accordion-body">
                                        The system will automatically verify your location. Make sure location services are enabled for best results.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="position-fixed top-0 end-0 p-3" style="z-index: 11">
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else 'success' }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <script>
        // Function to show recent attendance status if any
        function checkRecentAttendance() {
            const urlParams = new URLSearchParams(window.location.search);
            const attendanceStatus = urlParams.get('attendance');
            
            if (attendanceStatus === 'success') {
                const resultDiv = document.getElementById('attendanceResult');
                resultDiv.innerHTML = `
                    <div class="alert alert-success alert-dismissible fade show">
                        <strong>âœ… Attendance Marked Successfully!</strong>
                        <p>Your attendance has been recorded. Thank you!</p>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;
                
                // Remove the parameter from URL without reloading
                const newUrl = window.location.pathname;
                window.history.replaceState({}, document.title, newUrl);
            }
        }
        
        // Check for recent attendance on page load
        document.addEventListener('DOMContentLoaded', function() {
            checkRecentAttendance();
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
